name: Deploy Backend to App Server

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 21 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle 빌드
      - name: Build with Gradle
        working-directory: ./backend
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. JAR 파일 이름 확인
      - name: Get JAR filename
        id: jar
        working-directory: ./backend
        run: |
          cd build/libs
          JAR_FILE=$(ls *.jar | head -n 1)
          echo "filename=$JAR_FILE" >> $GITHUB_OUTPUT

      # 5. backend/.env 생성 (GitHub Secret에서 주입)
      - name: Create backend .env file
        working-directory: ./backend
        env:
          BACKEND_ENV_FILE: ${{ secrets.BACKEND_ENV_FILE }}
        run: |
          if [ -z "$BACKEND_ENV_FILE" ]; then
            echo "BACKEND_ENV_FILE secret is not set." >&2
            exit 1
          fi
          printf "%s" "$BACKEND_ENV_FILE" > .env

      # 6. JAR 파일 전송 (Bastion으로)
      - name: Copy JAR to Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          source: "backend/build/libs/${{ steps.jar.outputs.filename }}"
          target: "/tmp/"

      # 7. .env 파일 전송 (Bastion으로)
      - name: Copy .env to Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          source: "backend/.env"
          target: "/tmp/"

      # 8. App Server로 전송 및 재시작
      - name: Deploy to App Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          script: |
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' scp -o StrictHostKeyChecking=no /tmp/backend/build/libs/${{ steps.jar.outputs.filename }} ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }}:/app/backend/app.jar
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' scp -o StrictHostKeyChecking=no /tmp/backend/.env ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }}:/app/backend/.env
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }} "sudo systemctl restart springboot"
