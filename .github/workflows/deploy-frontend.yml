name: Deploy Frontend to App Servers

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Node.js 설정
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3. 환경 변수 파일 생성
      - name: Create .env file
        working-directory: ./frontend
        run: |
          {
            printf 'VITE_API_BASE_URL="%s"\n' "${{ secrets.VITE_API_BASE_URL }}";
            printf 'VITE_KAKAO_MAP_API_KEY="%s"\n' "${{ secrets.VITE_KAKAO_MAP_API_KEY }}";
          } > .env
          echo "Generated frontend/.env:" && cat .env

      # 4. 의존성 설치 및 빌드
      - name: Install and Build
        working-directory: ./frontend
        run: |
          npm install
          npm run build

      # 5. 빌드 파일 압축
      - name: Compress build files
        run: |
          cd frontend/dist
          tar -czf ../../frontend-build.tar.gz *

      # 6. 빌드 파일 전송 (Bastion으로)
      - name: Copy build to Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          source: "frontend-build.tar.gz"
          target: "/tmp/"

      # 7. App Server 1로 배포
      - name: Deploy to App Server 1
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          script: |
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' scp -o StrictHostKeyChecking=no /tmp/frontend-build.tar.gz ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }}:/tmp/
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }} "cd /var/www/html/build && rm -rf * && tar -xzf /tmp/frontend-build.tar.gz && rm /tmp/frontend-build.tar.gz"

      # 8. App Server 2로 배포
      - name: Deploy to App Server 2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          script: |
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' scp -o StrictHostKeyChecking=no /tmp/frontend-build.tar.gz ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_2_IP }}:/tmp/
            sshpass -p '${{ secrets.BASTION_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_2_IP }} "cd /var/www/html/build && rm -rf * && tar -xzf /tmp/frontend-build.tar.gz && rm /tmp/frontend-build.tar.gz"
