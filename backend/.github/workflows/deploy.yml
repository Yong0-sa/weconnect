name: Deploy Spring Boot to NCP.

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 21 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle 빌드
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. JAR 파일 이름 확인
      - name: Get JAR filename
        id: jar
        run: |
          cd build/libs
          JAR_FILE=$(ls *.jar | head -n 1)
          echo "filename=$JAR_FILE" >> $GITHUB_OUTPUT

      # 5. JAR 파일 전송 (Bastion으로)
      - name: Copy JAR to Bastion
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          source: "build/libs/${{ steps.jar.outputs.filename }}"
          target: "/tmp/"

      # 6. App Server 1로 전송 및 재시작
      - name: Deploy and Restart App Server 1
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          script: |
            echo "Deploying to App Server 1..."
            scp -i ~/.ssh/id_rsa /tmp/build/libs/${{ steps.jar.outputs.filename }} ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }}:/app/backend/app.jar
            ssh -i ~/.ssh/id_rsa ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_1_IP }} "systemctl restart springboot"
            echo "App Server 1 deployment completed!"

      # 7. App Server 2로 전송 및 재시작
      - name: Deploy and Restart App Server 2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          password: ${{ secrets.BASTION_PASSWORD }}
          script: |
            echo "Deploying to App Server 2..."
            scp -i ~/.ssh/id_rsa /tmp/build/libs/${{ steps.jar.outputs.filename }} ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_2_IP }}:/app/backend/app.jar
            ssh -i ~/.ssh/id_rsa ${{ secrets.APP_SERVER_USER }}@${{ secrets.APP_SERVER_2_IP }} "systemctl restart springboot"
            echo "App Server 2 deployment completed!"